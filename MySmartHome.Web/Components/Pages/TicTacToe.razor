@page "/games/tictactoe"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using MySmartHome.Web.Services
@inject NavigationManager Navigation
@inject GameService GameService
@implements IAsyncDisposable

<PageTitle>Tic-Tac-Toe</PageTitle>

<div class="tictactoe-container">
    <h1>Tic-Tac-Toe</h1>
    
    @if (isWaiting)
    {
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Waiting for another player...
        </div>
    }
    else if (opponentLeft)
    {
        <div class="alert alert-danger">
            Opponent disconnected.
            <button class="btn btn-primary ms-3" @onclick="JoinQueue">Find New Game</button>
        </div>
    }
    else
    {
        <div class="status-bar">
            @if (winner != null)
            {
                <div class="alert alert-success">
                    @if (winner == "Draw")
                    {
                        <span>It's a Draw!</span>
                    }
                    else
                    {
                        <span>Winner: @(winner == mySymbol ? "You" : "Opponent") (@winner)!</span>
                    }
                    <button class="btn btn-primary ms-3" @onclick="JoinQueue">Play Again</button>
                </div>
            }
            else
            {
                <div class="alert @(isMyTurn ? "alert-success" : "alert-secondary")">
                    @if (isMyTurn)
                    {
                        <span>Your Turn (@mySymbol)</span>
                    }
                    else
                    {
                        <span>Opponent's Turn (@(mySymbol == "X" ? "O" : "X"))</span>
                    }
                </div>
            }
        </div>

        <div class="board">
            @for (int i = 0; i < 9; i++)
            {
                int localI = i;
                <div class="cell @(board[i] != null ? "taken" : "")" @onclick="() => OnCellClick(localI)">
                    @board[i]
                </div>
            }
        </div>
    }
</div>

<style>
    .tictactoe-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 2rem;
    }

    .board {
        display: grid;
        grid-template-columns: repeat(3, 100px);
        grid-template-rows: repeat(3, 100px);
        gap: 10px;
        background-color: #333;
        padding: 10px;
        border-radius: 10px;
    }

    .cell {
        background-color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
    }

    .cell:hover:not(.taken) {
        background-color: #eee;
    }

    .cell.taken {
        cursor: default;
        color: #333;
    }

    .status-bar {
        margin-bottom: 1rem;
        font-size: 1.2rem;
        text-align: center;
    }
</style>

@code {
    private string playerId = Guid.NewGuid().ToString();
    private string?[] board = new string?[9];
    private bool isWaiting = true;
    private bool opponentLeft = false;
    private string? mySymbol;
    private bool isMyTurn = false;
    private string? winner = null;

    protected override void OnInitialized()
    {
        GameService.OnWaiting += HandleWaiting;
        GameService.OnGameStarted += HandleGameStarted;
        GameService.OnGameUpdated += HandleGameUpdated;
        GameService.OnOpponentLeft += HandleOpponentLeft;

        JoinQueue();
    }

    private void JoinQueue()
    {
        GameService.JoinQueue(playerId);
    }

    private void HandleWaiting(string pId)
    {
        if (pId == playerId)
        {
            isWaiting = true;
            opponentLeft = false;
            winner = null;
            board = new string?[9];
            InvokeAsync(StateHasChanged);
        }
    }

    private void HandleGameStarted(string pId, string symbol, bool isTurn)
    {
        if (pId == playerId)
        {
            isWaiting = false;
            opponentLeft = false;
            mySymbol = symbol;
            isMyTurn = isTurn;
            winner = null;
            board = new string?[9];
            InvokeAsync(StateHasChanged);
        }
    }

    private void HandleGameUpdated(string pId, string?[] newBoard, bool isTurn, string? winSymbol, bool isDraw)
    {
        if (pId == playerId)
        {
            board = newBoard;
            isMyTurn = isTurn;
            if (winSymbol != null) winner = winSymbol;
            else if (isDraw) winner = "Draw";
            
            InvokeAsync(StateHasChanged);
        }
    }

    private void HandleOpponentLeft(string pId)
    {
        if (pId == playerId)
        {
            if (winner == null)
            {
                opponentLeft = true;
                isWaiting = false;
                InvokeAsync(StateHasChanged);
            }
        }
    }

    private void OnCellClick(int index)
    {
        if (isMyTurn && board[index] == null && winner == null)
        {
            GameService.MakeMove(playerId, index);
        }
    }

    public ValueTask DisposeAsync()
    {
        GameService.OnWaiting -= HandleWaiting;
        GameService.OnGameStarted -= HandleGameStarted;
        GameService.OnGameUpdated -= HandleGameUpdated;
        GameService.OnOpponentLeft -= HandleOpponentLeft;
        
        GameService.RemovePlayer(playerId);
        
        return ValueTask.CompletedTask;
    }
}
